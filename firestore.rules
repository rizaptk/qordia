rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isPlatformAdmin() {
      return isSignedIn() && request.auth.token.platform_admin == true;
    }

    function isStaffOfTenant(tenantId) {
      return isSignedIn() && request.auth.token.tenantId == tenantId && (request.auth.token.role == 'manager' || request.auth.token.role == 'barista' || request.auth.token.role == 'service');
    }

    function isManagerOfTenant(tenantId) {
      return isSignedIn() && request.auth.token.tenantId == tenantId && request.auth.token.role == 'manager';
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Rules for top-level collections
    match /tenants/{tenantId} {
      allow read: if isStaffOfTenant(tenantId) || isPlatformAdmin();
      allow list, create, update, delete: if isPlatformAdmin();
    }

    match /users/{userId} {
      allow read, update: if isOwner(userId) || isPlatformAdmin();
      allow list, create, delete: if isPlatformAdmin();
    }

    // Rules for tenant subcollections
    match /tenants/{tenantId}/{document=**} {
      // Platform admins can read/write everything.
      allow read, write: if isPlatformAdmin();
    }

    // Menu data is public-readable for customers
    match /tenants/{tenantId}/menu_categories/{categoryId} {
      allow get, list: if true;
      allow write: if isManagerOfTenant(tenantId);
    }
    match /tenants/{tenantId}/menu_items/{itemId} {
      allow get, list: if true;
      allow write: if isManagerOfTenant(tenantId);
    }
    match /tenants/{tenantId}/locations/{locationId} {
      allow get, list: if true;
      allow write: if isManagerOfTenant(tenantId);
    }
    match /tenants/{tenantId}/tables/{tableId} {
      allow get, list: if true;
      allow write: if isManagerOfTenant(tenantId);
    }

    // Orders can be created by any authenticated user, but only read/updated by the owner or tenant staff.
    match /tenants/{tenantId}/orders/{orderId} {
      allow get, list: if isStaffOfTenant(tenantId) || (isSignedIn() && resource.data.customerId == request.auth.uid);
      allow create: if isSignedIn(); // Further checks (e.g., matching customerId) should be in app logic.
      allow update: if isStaffOfTenant(tenantId) || (isSignedIn() && resource.data.customerId == request.auth.uid);
    }
  }
}
